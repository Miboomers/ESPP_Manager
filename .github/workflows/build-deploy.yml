name: Windows & Web Build

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.0'
        channel: 'stable'
        
    - name: Enable Windows Desktop
      run: flutter config --enable-windows-desktop
      
    - name: Install dependencies
      run: flutter pub get
      
    - name: Build Windows Release
      run: flutter build windows --release
      
    - name: Create Windows Package
      shell: powershell
      run: |
        $date = Get-Date -Format "yyyyMMdd_HHmm"
        $distName = "ESPP_Manager_Windows_$date"
        
        New-Item -ItemType Directory -Path "dist" -Force
        Copy-Item -Path "build\windows\x64\runner\Release" -Destination "dist\$distName" -Recurse
        
        # Einfache README
        @"
ESPP Manager für Windows
========================

Start: espp_manager.exe ausführen
Bei Sicherheitswarnung: "Weitere Informationen" → "Trotzdem ausführen"

Cloud Sync und alle Features funktionieren wie auf macOS/iOS.
"@ | Out-File -FilePath "dist\$distName\README.txt" -Encoding UTF8

        Compress-Archive -Path "dist\$distName" -DestinationPath "dist\$distName.zip"
        
    - name: Upload Windows Build
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: dist/*.zip
        retention-days: 30

  build-web:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.0'
        channel: 'stable'
        
    - name: Enable Web & Install dependencies
      run: |
        flutter config --enable-web
        flutter pub get
        
    - name: Build Web Release
      run: flutter build web --release --web-renderer html --base-href /
      
    - name: Package Web Build
      run: |
        DATE=$(date +%Y%m%d_%H%M)
        DIST_NAME="ESPP_Manager_Web_$DATE"
        
        mkdir -p dist
        cp -r build/web "dist/$DIST_NAME"
        
        # Index.html Anpassungen für Firebase Hosting
        cat > "dist/$DIST_NAME/firebase-hosting.md" << EOF
# Web Deployment Instructions

## Local Testing:
\`\`\`bash
cd $DIST_NAME
python3 -m http.server 8000
# Öffnen: http://localhost:8000
\`\`\`

## Firebase Hosting Deployment:
\`\`\`bash
npm install -g firebase-tools
firebase init hosting
firebase deploy
\`\`\`

## GitHub Pages Deployment:
1. Push this folder to gh-pages branch
2. Enable GitHub Pages in repo settings
3. Access at: https://[username].github.io/ESPP_Manager

Features:
✅ Läuft komplett im Browser
✅ Cloud Sync mit Firebase
✅ Offline-fähig mit IndexedDB
✅ Plattformunabhängig
EOF
        
        cd dist && zip -r "$DIST_NAME.zip" "$DIST_NAME"
        
    - name: Upload Web Build
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: dist/*.zip
        retention-days: 30

    - name: Deploy to GitHub Pages (nur bei main branch)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        cd build/web
        git init
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        git commit -m "Deploy Web App - $(date +%Y%m%d_%H%M)"
        git branch -M gh-pages
        git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push -f origin gh-pages

  create-release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-windows, build-web]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-files
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: ESPP Manager ${{ github.ref_name }}
        body: |
          # ESPP Manager Release ${{ github.ref_name }}
          
          ## 📥 Downloads
          
          ### Windows 💻
          - Download: `ESPP_Manager_Windows_*.zip`
          - Entpacken und `espp_manager.exe` starten
          
          ### Web 🌐
          - Download: `ESPP_Manager_Web_*.zip`
          - Oder direkt online: https://${{ github.repository_owner }}.github.io/ESPP_Manager
          
          ## 🔥 Features
          - Employee Stock Purchase Plan Verwaltung
          - Deutsche Steuerberechnungen (Lohnsteuer + Kapitalertragsteuer)
          - PDF-Berichte für Finanzamt
          - Cloud Sync zwischen allen Plattformen
          - Fidelity CSV Import
          - AES-256 Verschlüsselung
          
          ---
          **macOS/iOS**: Builds über Xcode/TestFlight verfügbar
        files: release-files/**/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}